<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TOEFL Speaking Mock Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      line-height: 1.6;
    }
    h1 {
      text-align: center;
    }
    .question {
      margin-top: 30px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
    }
    audio {
      margin-top: 10px;
      width: 100%;
    }
    
    /* æ–°å¢æ ·å¼ï¼šè€ƒè¯•ä¿¡æ¯æç¤ºæ¡† */
    .exam-info {
      background-color: #e8f4fd;
      border-left: 4px solid #2196F3;
      padding: 15px 20px;
      margin-bottom: 30px;
      border-radius: 0 8px 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .exam-info p {
      margin: 0;
      color: #1976D2;
      font-weight: 500;
    }
    
    .exam-info a {
      background-color: #2196F3;
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    .exam-info a:hover {
      background-color: #1976D2;
    }
    
    .exam-info a:visited {
      color: white;
    }
    
    /* æ–°å¢æ ·å¼ï¼šé¡µè„š */
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      text-align: center;
      color: #666;
    }
    
    .footer a {
      color: #2196F3;
      text-decoration: none;
    }
    
    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <!-- æ–°å¢ï¼šé¡¶éƒ¨è€ƒè¯•ä¿¡æ¯æç¤ºæ¡† -->
  <div class="exam-info">
    <p>ğŸ“‹ è¯·ä»”ç»†é˜…è¯»è€ƒè¯•è§„åˆ™å’Œè¯´æ˜</p>
    <a href="README.md" target="_blank">æŸ¥çœ‹è€ƒè¯•è¯´æ˜ â†’</a>
  </div>

  <h1>TOEFL Speaking Test</h1>

  <div class="question">
    <h2>Part 1: Listen & Repeat</h2>
    <p>Listen to the sentence and repeat it.</p>

    <audio controls>
      <source src="audio/part1_sentence1.mp3.mp3" type="audio/mpeg">
    </audio>

    <audio controls>
      <source src="audio/part1_sentence2.mp3.mp3" type="audio/mpeg">
    </audio>

    <audio controls>
      <source src="audio/part1_sentence3.mp3.mp3" type="audio/mpeg">
    </audio>

    <audio controls>
      <source src="audio/part1_sentence4.mp3.mp3" type="audio/mpeg">
    </audio>

    <button onclick="startRecording(event)">Start Recording</button>
  </div>

  <div class="question">
    <h2>Part 2: Interview Question</h2>
    <p>Describe a teacher who has influenced you. â€” Watch student responses:</p>

    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;">
      <div style="flex: 1 1 calc(50% - 20px); background: #f9f9f9; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <video width="100%" height="180" controls style="border-radius: 8px;">
          <source src="q1-interview.mp4" type="video/mp4">
        </video>
        <p style="font-weight: bold; margin-top: 10px;">ğŸ“Œ Question 1</p>
      </div>
      <div style="flex: 1 1 calc(50% - 20px); background: #f9f9f9; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <video width="100%" height="180" controls style="border-radius: 8px;">
          <source src="q2-interview.mp4" type="video/mp4">
        </video>
        <p style="font-weight: bold; margin-top: 10px;">ğŸ“Œ Question 2</p>
      </div>
      <div style="flex: 1 1 calc(50% - 20px); background: #f9f9f9; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <video width="100%" height="180" controls style="border-radius: 8px;">
          <source src="q3-interview.mp4" type="video/mp4">
        </video>
        <p style="font-weight: bold; margin-top: 10px;">ğŸ“Œ Question 3</p>
      </div>
      <div style="flex: 1 1 calc(50% - 20px); background: #f9f9f9; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <video width="100%" height="180" controls style="border-radius: 8px;">
          <source src="q4-interview.mp4" type="video/mp4">
        </video>
        <p style="font-weight: bold; margin-top: 10px;">ğŸ“Œ Question 4</p>
      </div>
    </div>

    <button onclick="startRecording(event)" style="margin-top: 20px;">Start Recording</button>
  </div>
  
  <!-- æ–°å¢ï¼šåº•éƒ¨é“¾æ¥ -->
  <div class="footer">
    <p>
      <a href="README.md" target="_blank">ğŸ“– æŸ¥çœ‹å®Œæ•´çš„è€ƒè¯•è§„åˆ™å’Œè¯´æ˜</a>
      <span style="margin: 0 10px; color: #ccc;">|</span>
      <a href="#" onclick="window.scrollTo({top: 0, behavior: 'smooth'}); return false;">â¬† è¿”å›é¡¶éƒ¨</a>
    </p>
    <p style="font-size: 12px; margin-top: 10px; color: #999;">
      Â© TOEFL Speaking Mock Test System | è€ƒè¯•æ—¶é—´: 8-10åˆ†é’Ÿ | è¯·å‹¿åˆ‡æ¢å±å¹•
    </p>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let mediaRecorder;
    let audioChunks = [];
    let recordingStream = null;

    // Part 1 & Part 2 å…±ç”¨çš„å½•éŸ³å‡½æ•°
    async function startRecording(event) {
      // âœ… ä¿®å¤ï¼šç¡®ä¿ event å­˜åœ¨
      if (!event) event = window.event;
      
      try {
        // 1. æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        if (!navigator.mediaDevices || !window.MediaRecorder) {
          alert('âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ã€‚è¯·ä½¿ç”¨ Chromeã€Firefox æˆ– Edge æœ€æ–°ç‰ˆæœ¬ã€‚');
          return;
        }

        // 2. è¯·æ±‚éº¦å…‹é£æƒé™
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 16000
          } 
        });
        
        recordingStream = stream;
        
        // 3. åˆå§‹åŒ– MediaRecorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        // 4. æ”¶é›†éŸ³é¢‘æ•°æ®å—
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        // 5. å½•éŸ³åœæ­¢æ—¶çš„å¤„ç†
        mediaRecorder.onstop = () => {
          // ç”ŸæˆéŸ³é¢‘æ–‡ä»¶
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          
          // åˆ›å»ºä¸´æ—¶éŸ³é¢‘æ’­æ”¾å™¨ç”¨äºå›æ”¾
          const audioPlayer = document.createElement('audio');
          audioPlayer.controls = true;
          audioPlayer.src = audioUrl;
          audioPlayer.style.width = '100%';
          audioPlayer.style.marginTop = '10px';
          
          // å°†æ’­æ”¾å™¨æ’å…¥åˆ°å½“å‰ç‚¹å‡»çš„æŒ‰é’®åé¢
          const activeButton = document.activeElement;
          if (activeButton && activeButton.tagName === 'BUTTON') {
            activeButton.parentNode.insertBefore(audioPlayer, activeButton.nextSibling);
          }
          
          console.log('âœ… å½•éŸ³å®Œæˆ');
          
          // é‡Šæ”¾éº¦å…‹é£èµ„æº
          if (recordingStream) {
            recordingStream.getTracks().forEach(track => track.stop());
            recordingStream = null;
          }
          
          // æ¸…ç©ºæ•°æ®å—
          audioChunks = [];
        };

        // 6. å¼€å§‹å½•éŸ³
        mediaRecorder.start();
        console.log('ğŸ¤ å½•éŸ³å·²å¼€å§‹');
        
        // 7. æ”¹å˜æŒ‰é’®çŠ¶æ€
        const currentBtn = event.target;
        if (currentBtn) {
          currentBtn.textContent = 'ğŸ”´ å½•éŸ³ä¸­...';
          currentBtn.style.background = '#ff4444';
          currentBtn.style.color = 'white';
          currentBtn.disabled = true;
          
          // æ·»åŠ åœæ­¢æŒ‰é’®
          const stopBtn = document.createElement('button');
          stopBtn.textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
          stopBtn.style.marginLeft = '10px';
          stopBtn.style.background = '#666';
          stopBtn.style.color = 'white';
          stopBtn.onclick = stopRecording;
          currentBtn.parentNode.insertBefore(stopBtn, currentBtn.nextSibling);
        }
        
      } catch (err) {
        console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', err);
        if (err.name === 'NotAllowedError') {
          alert('âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨åœ°å€æ çš„æƒé™è®¾ç½®ã€‚');
        } else if (err.name === 'NotFoundError') {
          alert('âŒ æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡ã€‚è¯·è¿æ¥éº¦å…‹é£åé‡è¯•ã€‚');
        } else {
          alert(`å½•éŸ³å¤±è´¥: ${err.message}`);
        }
      }
    }

    // åœæ­¢å½•éŸ³å‡½æ•°
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        console.log('â¹ï¸ å½•éŸ³å·²åœæ­¢');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const recordBtns = document.querySelectorAll('button[onclick="startRecording(event)"]');
        recordBtns.forEach(btn => {
          btn.textContent = 'Start Recording';
          btn.style.background = '';
          btn.style.color = '';
          btn.disabled = false;
        });
        
        // ç§»é™¤åœæ­¢æŒ‰é’®
        const stopBtns = document.querySelectorAll('button[onclick="stopRecording()"]');
        stopBtns.forEach(btn => btn.remove());
      }
    }

    // é¡µé¢å¸è½½æ—¶é‡Šæ”¾èµ„æº
    window.addEventListener('beforeunload', () => {
      if (recordingStream) {
        recordingStream.getTracks().forEach(track => track.stop());
      }
    });
  </script>
  
</body>
</html>
<!-- force rebuild -->
